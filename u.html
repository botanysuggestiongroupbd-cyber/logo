<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Image Watermark Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* All CSS remains the same as before up to the upload-section */
        
        .upload-section {
            border: 3px dashed #a0a0a0;
            padding: 40px 20px;
            text-align: center;
            border-radius: 15px;
            transition: all 0.3s ease;
            background: #fafafa;
            position: relative;
            cursor: pointer;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* ... rest of your CSS remains exactly the same ... */
        
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∑ Batch Image Watermark Tool</h1>
            <p class="subtitle">Add watermarks to multiple images at once</p>
        </header>
        
        <!-- Features Section -->
        <div class="card">
            <h2 class="section-title">Key Features</h2>
            <div class="feature-grid">
                <div class="feature-item">
                    <div class="feature-icon">üî§</div>
                    <div class="feature-title">Text Watermarks</div>
                    <div class="feature-desc">Add custom text with various fonts and styles</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üñºÔ∏è</div>
                    <div class="feature-title">Image Watermarks</div>
                    <div class="feature-desc">Use images as watermarks with size control</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üì¶</div>
                    <div class="feature-title">Batch Processing</div>
                    <div class="feature-desc">Process multiple images simultaneously</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üì•</div>
                    <div class="feature-title">Flexible Download</div>
                    <div class="feature-desc">Download individually or as ZIP archive</div>
                </div>
            </div>
        </div>
        
        <!-- Upload Section - FIXED VERSION -->
        <div class="card">
            <h2 class="section-title">Upload Images</h2>
            <div class="upload-section" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>Upload Your Images</h3>
                <p>Select multiple images at once</p>
                
                <div class="file-input-container">
                    <button type="button" class="file-input-button" id="fileInputButton">
                        üì∏ Select Images
                    </button>
                    <!-- FIXED: Simple file input without complex styling -->
                    <input type="file" id="imageInput" 
                           accept="image/*" 
                           multiple 
                           style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                </div>
                
                <div class="file-info" id="fileInfo">
                    No files selected
                </div>
                
                <div class="mobile-instruction">
                    <div class="instruction-title">üì± Mobile Selection Tips:</div>
                    <div>1. Tap "Select Images" button</div>
                    <div>2. Choose from Gallery, Photos, Files, or Drive</div>
                    <div>3. Tap and hold to select multiple images</div>
                    <div>4. Tap "Done" or "Open" when finished</div>
                </div>
            </div>

            <div class="selected-files hidden" id="selectedFiles">
                <h4>Selected Images:</h4>
                <ul class="file-list" id="fileList"></ul>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats hidden" id="statsSection">
            <div class="stat-item">
                <div class="stat-value" id="totalCount">0</div>
                <div>Total Images</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="processedCount">0</div>
                <div>Processed</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="remainingCount">0</div>
                <div>Remaining</div>
            </div>
        </div>

        <!-- Watermark Controls -->
        <div class="card">
            <h2 class="section-title">Watermark Settings</h2>
            
            <div class="watermark-type">
                <div class="type-btn active" data-type="text">üìù Text</div>
                <div class="type-btn" data-type="image">üñºÔ∏è Image</div>
                <div class="type-btn" data-type="both">üî§+üñºÔ∏è Both</div>
            </div>
            
            <!-- Text Watermark Controls -->
            <div id="textControls">
                <div class="control-group">
                    <label class="control-label">Watermark Text</label>
                    <input type="text" id="watermarkText" class="control-input" value="Your Watermark" placeholder="Enter your watermark text">
                </div>
                
                <div class="control-group">
                    <label class="control-label">Font Settings</label>
                    <div class="font-selector">
                        <select id="fontFamily" class="control-input">
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Impact">Impact</option>
                            <option value="Comic Sans MS">Comic Sans MS</option>
                            <option value="Trebuchet MS">Trebuchet MS</option>
                            <option value="Palatino">Palatino</option>
                        </select>
                        <div class="font-preview" id="fontPreview" style="font-family: Arial;">
                            Font Preview
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Text Style</label>
                    <div class="color-selector-group">
                        <div class="color-selector">
                            <label class="control-label">Text Color</label>
                            <div class="color-preview" id="textColorPreview">
                                <div class="color-preview-background" id="textColorBackground"></div>
                                <div class="color-preview-text">Selected Color</div>
                            </div>
                            <input type="color" id="textColor" class="color-input-hidden" value="#ffffff">
                            <div class="color-options" id="textColorOptions">
                                <!-- Color options will be added dynamically -->
                            </div>
                        </div>
                        <input type="number" id="textSize" class="control-input size-input" value="24" min="10" max="100" placeholder="Font Size">
                    </div>
                </div>
            </div>
            
            <!-- Image Watermark Controls -->
            <div id="imageControls" class="hidden">
                <!-- Logo Source Selection -->
                <div class="control-group">
                    <label class="control-label">Logo Source</label>
                    <div class="logo-source-selector">
                        <div class="logo-source-btn active" data-source="predefined">üìÅ Predefined Logos</div>
                        <div class="logo-source-btn" data-source="upload">üì§ Upload Logo</div>
                    </div>
                </div>
                
                <!-- Predefined Logos Section -->
                <div id="predefinedLogoSection">
                    <div class="control-group">
                        <label class="control-label">Select Predefined Logo</label>
                        <div class="predefined-logos" id="predefinedLogos">
                            <!-- Predefined logos will be added here dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Upload Logo Section -->
                <div id="uploadLogoSection" class="hidden">
                    <div class="control-group">
                        <label class="control-label">Watermark Image</label>
                        <div style="position: relative;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('watermarkImage').click()" style="width: 100%; margin-bottom: 10px;">
                                üì§ Upload Logo Image
                            </button>
                            <input type="file" id="watermarkImage" accept="image/*" style="display: none;">
                        </div>
                        <img id="watermarkPreview" class="watermark-preview hidden" alt="Watermark Preview">
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Image Size (%)</label>
                    <div class="slider-group">
                        <input type="range" id="imageSize" class="slider" min="5" max="50" value="20">
                        <span id="imageSizeValue">20%</span>
                    </div>
                </div>
            </div>
            
            <!-- Both Watermark Controls -->
            <div id="bothControls" class="hidden">
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <div class="custom-checkbox checked" id="textCheckbox"></div>
                        Text Watermark
                    </label>
                    <label class="checkbox-label">
                        <div class="custom-checkbox checked" id="imageCheckbox"></div>
                        Image Watermark
                    </label>
                </div>
                
                <div id="bothTextControls">
                    <div class="control-group">
                        <label class="control-label">Watermark Text</label>
                        <input type="text" id="bothWatermarkText" class="control-input" value="Your Watermark" placeholder="Enter your watermark text">
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Font Settings</label>
                        <div class="font-selector">
                            <select id="bothFontFamily" class="control-input">
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Impact">Impact</option>
                                <option value="Comic Sans MS">Comic Sans MS</option>
                                <option value="Trebuchet MS">Trebuchet MS</option>
                                <option value="Palatino">Palatino</option>
                            </select>
                            <div class="font-preview" id="bothFontPreview" style="font-family: Arial;">
                                Font Preview
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Text Style</label>
                        <div class="color-selector-group">
                            <div class="color-selector">
                                <label class="control-label">Text Color</label>
                                <div class="color-preview" id="bothTextColorPreview">
                                    <div class="color-preview-background" id="bothTextColorBackground"></div>
                                    <div class="color-preview-text">Selected Color</div>
                                </div>
                                <input type="color" id="bothTextColor" class="color-input-hidden" value="#ffffff">
                                <div class="color-options" id="bothTextColorOptions">
                                    <!-- Color options will be added dynamically -->
                                </div>
                            </div>
                            <input type="number" id="bothTextSize" class="control-input size-input" value="24" min="10" max="100" placeholder="Font Size">
                        </div>
                    </div>
                </div>
                
                <div id="bothImageControls">
                    <!-- Logo Source Selection for Both -->
                    <div class="control-group">
                        <label class="control-label">Logo Source</label>
                        <div class="logo-source-selector">
                            <div class="logo-source-btn active" data-source="predefined">üìÅ Predefined Logos</div>
                            <div class="logo-source-btn" data-source="upload">üì§ Upload Logo</div>
                        </div>
                    </div>
                    
                    <!-- Predefined Logos Section for Both -->
                    <div id="bothPredefinedLogoSection">
                        <div class="control-group">
                            <label class="control-label">Select Predefined Logo</label>
                            <div class="predefined-logos" id="bothPredefinedLogos">
                                <!-- Predefined logos will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Logo Section for Both -->
                    <div id="bothUploadLogoSection" class="hidden">
                        <div class="control-group">
                            <label class="control-label">Watermark Image</label>
                            <div style="position: relative;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('bothWatermarkImage').click()" style="width: 100%; margin-bottom: 10px;">
                                    üì§ Upload Logo Image
                                </button>
                                <input type="file" id="bothWatermarkImage" accept="image/*" style="display: none;">
                            </div>
                            <img id="bothWatermarkPreview" class="watermark-preview hidden" alt="Watermark Preview">
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Image Size (%)</label>
                        <div class="slider-group">
                            <input type="range" id="bothImageSize" class="slider" min="5" max="50" value="20">
                            <span id="bothImageSizeValue">20%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Common Controls -->
            <div class="control-group">
                <label class="control-label">Opacity</label>
                <div class="slider-group">
                    <input type="range" id="opacity" class="slider" min="0.1" max="1" step="0.1" value="0.7">
                    <span id="opacityValue">70%</span>
                </div>
            </div>
            
            <div class="control-group">
                <label class="control-label">Position</label>
                <select id="position" class="control-input">
                    <option value="bottom-right">Bottom Right</option>
                    <option value="bottom-left">Bottom Left</option>
                    <option value="top-right">Top Right</option>
                    <option value="top-left">Top Left</option>
                    <option value="center">Center</option>
                    <option value="tile">Tile All Over</option>
                </select>
            </div>
            
            <button id="processBtn" class="btn btn-primary" disabled>Add Watermark</button>
        </div>

        <!-- Progress Section -->
        <div class="card">
            <h2 class="section-title">Processing</h2>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="progress-text" id="progressText">0% Complete</div>
            </div>
            
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Processing images...</p>
            </div>
            
            <div class="download-buttons hidden" id="downloadButtons">
                <button id="downloadAllBtn" class="btn btn-success">Download All Images</button>
                <button id="downloadZipBtn" class="btn btn-secondary">Download as ZIP</button>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="card">
            <h2 class="section-title">Preview</h2>
            <div class="preview-section" id="previewSection">
                <div style="text-align: center; padding: 40px; color: #666;">
                    Uploaded images will appear here
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Large Preview -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">‚úï</button>
            <button class="modal-nav modal-prev" id="modalPrev">‚ùÆ</button>
            <img class="modal-img" id="modalImg" src="" alt="Large Preview">
            <button class="modal-nav modal-next" id="modalNext">‚ùØ</button>
            <div class="modal-info" id="modalInfo"></div>
        </div>
    </div>

    <script>
        // DOM Elements
        const imageInput = document.getElementById('imageInput');
        const fileInputButton = document.getElementById('fileInputButton');
        const fileInfo = document.getElementById('fileInfo');
        const uploadArea = document.getElementById('uploadArea');
        const selectedFiles = document.getElementById('selectedFiles');
        const fileList = document.getElementById('fileList');
        const watermarkText = document.getElementById('watermarkText');
        const textColor = document.getElementById('textColor');
        const textColorPreview = document.getElementById('textColorPreview');
        const textColorBackground = document.getElementById('textColorBackground');
        const textColorOptions = document.getElementById('textColorOptions');
        const textSize = document.getElementById('textSize');
        const opacity = document.getElementById('opacity');
        const opacityValue = document.getElementById('opacityValue');
        const position = document.getElementById('position');
        const processBtn = document.getElementById('processBtn');
        const progress = document.getElementById('progress');
        const progressText = document.getElementById('progressText');
        const previewSection = document.getElementById('previewSection');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const downloadZipBtn = document.getElementById('downloadZipBtn');
        const downloadButtons = document.getElementById('downloadButtons');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const statsSection = document.getElementById('statsSection');
        const totalCount = document.getElementById('totalCount');
        const processedCount = document.getElementById('processedCount');
        const remainingCount = document.getElementById('remainingCount');

        // Watermark type elements
        const typeButtons = document.querySelectorAll('.type-btn');
        const textControls = document.getElementById('textControls');
        const imageControls = document.getElementById('imageControls');
        const bothControls = document.getElementById('bothControls');
        const watermarkImage = document.getElementById('watermarkImage');
        const watermarkPreview = document.getElementById('watermarkPreview');
        const imageSize = document.getElementById('imageSize');
        const imageSizeValue = document.getElementById('imageSizeValue');

        // Font elements
        const fontFamily = document.getElementById('fontFamily');
        const fontPreview = document.getElementById('fontPreview');
        const bothFontFamily = document.getElementById('bothFontFamily');
        const bothFontPreview = document.getElementById('bothFontPreview');

        // Both watermark elements
        const textCheckbox = document.getElementById('textCheckbox');
        const imageCheckbox = document.getElementById('imageCheckbox');
        const bothTextControls = document.getElementById('bothTextControls');
        const bothImageControls = document.getElementById('bothImageControls');
        const bothWatermarkText = document.getElementById('bothWatermarkText');
        const bothTextColor = document.getElementById('bothTextColor');
        const bothTextColorPreview = document.getElementById('bothTextColorPreview');
        const bothTextColorBackground = document.getElementById('bothTextColorBackground');
        const bothTextColorOptions = document.getElementById('bothTextColorOptions');
        const bothTextSize = document.getElementById('bothTextSize');
        const bothWatermarkImage = document.getElementById('bothWatermarkImage');
        const bothWatermarkPreview = document.getElementById('bothWatermarkPreview');
        const bothImageSize = document.getElementById('bothImageSize');
        const bothImageSizeValue = document.getElementById('bothImageSizeValue');

        // Modal elements
        const previewModal = document.getElementById('previewModal');
        const modalClose = document.getElementById('modalClose');
        const modalImg = document.getElementById('modalImg');
        const modalPrev = document.getElementById('modalPrev');
        const modalNext = document.getElementById('modalNext');
        const modalInfo = document.getElementById('modalInfo');

        // New elements for predefined logos
        const logoSourceButtons = document.querySelectorAll('.logo-source-btn');
        const uploadLogoSection = document.getElementById('uploadLogoSection');
        const predefinedLogoSection = document.getElementById('predefinedLogoSection');
        const predefinedLogos = document.getElementById('predefinedLogos');
        const bothUploadLogoSection = document.getElementById('bothUploadLogoSection');
        const bothPredefinedLogoSection = document.getElementById('bothPredefinedLogoSection');
        const bothPredefinedLogos = document.getElementById('bothPredefinedLogos');

        // Global variables
        let originalImages = [];
        let watermarkedImages = [];
        let currentWatermarkType = 'text';
        let watermarkImageData = null;
        let bothWatermarkImageData = null;
        let currentPreviewIndex = 0;
        let currentPreviewType = 'original';
        let selectedPredefinedLogo = null;
        let selectedBothPredefinedLogo = null;
        let currentLogoSource = 'predefined';
        let currentBothLogoSource = 'predefined';

        // Predefined logos data
        const predefinedLogosData = [
            {
                name: "Original",
                url: "L1.png"
            },
            {
                name: "Dark", 
                url: "L2.png"
            },
            {
                name: "Green",
                url: "L3.png"
            },
            {
                name: "Black And White",
                url: "L4.png"
            }
        ];

        // Color options for the color picker
        const colorOptions = [
            '#ffffff', '#000000', '#ff0000', '#00ff00', '#0000ff', 
            '#ffff00', '#ff00ff', '#00ffff', '#ff6b6b', '#4ecdc4',
            '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff',
            '#5f27cd', '#00d2d3', '#ff9f43', '#10ac84', '#ee5a24'
        ];

        // Event Listeners - FIXED: Simple event listener setup
        imageInput.addEventListener('change', handleImageUpload);
        
        // When button is clicked, also trigger file input
        fileInputButton.addEventListener('click', function(e) {
            e.stopPropagation();
            imageInput.click();
        });
        
        // When upload area is clicked, trigger file input
        uploadArea.addEventListener('click', function(e) {
            if (e.target !== fileInputButton && e.target !== imageInput) {
                imageInput.click();
            }
        });

        opacity.addEventListener('input', updateOpacityValue);
        imageSize.addEventListener('input', updateImageSizeValue);
        bothImageSize.addEventListener('input', updateBothImageSizeValue);
        processBtn.addEventListener('click', processAllImages);
        downloadAllBtn.addEventListener('click', downloadAllImages);
        downloadZipBtn.addEventListener('click', downloadAsZip);
        watermarkImage.addEventListener('change', handleWatermarkImageUpload);
        bothWatermarkImage.addEventListener('change', handleBothWatermarkImageUpload);
        fontFamily.addEventListener('change', updateFontPreview);
        bothFontFamily.addEventListener('change', updateBothFontPreview);

        // Modal event listeners
        modalClose.addEventListener('click', closeModal);
        modalPrev.addEventListener('click', showPrevImage);
        modalNext.addEventListener('click', showNextImage);
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) closeModal();
        });

        // Checkbox event listeners
        textCheckbox.addEventListener('click', toggleTextWatermark);
        imageCheckbox.addEventListener('click', toggleImageWatermark);

        // Logo source event listeners
        logoSourceButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const source = btn.dataset.source;
                
                if (btn.closest('#bothImageControls')) {
                    currentBothLogoSource = source;
                    document.querySelectorAll('#bothImageControls .logo-source-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    if (source === 'upload') {
                        bothUploadLogoSection.classList.remove('hidden');
                        bothPredefinedLogoSection.classList.add('hidden');
                    } else {
                        bothUploadLogoSection.classList.add('hidden');
                        bothPredefinedLogoSection.classList.remove('hidden');
                    }
                } else {
                    currentLogoSource = source;
                    document.querySelectorAll('#imageControls .logo-source-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    if (source === 'upload') {
                        uploadLogoSection.classList.remove('hidden');
                        predefinedLogoSection.classList.add('hidden');
                    } else {
                        uploadLogoSection.classList.add('hidden');
                        predefinedLogoSection.classList.remove('hidden');
                    }
                }
            });
        });

        // Color picker event listeners
        textColorPreview.addEventListener('click', () => {
            textColor.click();
        });

        textColor.addEventListener('input', () => {
            updateColorPreview(textColor.value, textColorBackground, textColorOptions);
        });

        bothTextColorPreview.addEventListener('click', () => {
            bothTextColor.click();
        });

        bothTextColor.addEventListener('input', () => {
            updateColorPreview(bothTextColor.value, bothTextColorBackground, bothTextColorOptions);
        });

        // Watermark type switching
        typeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                typeButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentWatermarkType = btn.dataset.type;
                
                textControls.classList.add('hidden');
                imageControls.classList.add('hidden');
                bothControls.classList.add('hidden');
                
                if (currentWatermarkType === 'text') {
                    textControls.classList.remove('hidden');
                } else if (currentWatermarkType === 'image') {
                    imageControls.classList.remove('hidden');
                } else if (currentWatermarkType === 'both') {
                    bothControls.classList.remove('hidden');
                }
            });
        });

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            // Handle dropped files
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Create a fake event object
                handleImageUpload({ target: { files: files } });
            }
        });

        // Initialize predefined logos
        function initializePredefinedLogos() {
            predefinedLogos.innerHTML = '';
            bothPredefinedLogos.innerHTML = '';
            
            predefinedLogosData.forEach((logo, index) => {
                const logoItem = document.createElement('div');
                logoItem.className = 'predefined-logo-item';
                logoItem.dataset.index = index;
                
                // Create image with error handling
                const img = new Image();
                img.className = 'predefined-logo-img';
                img.alt = logo.name;
                img.onload = function() {
                    logoItem.innerHTML = `
                        <img src="${logo.url}" alt="${logo.name}" class="predefined-logo-img">
                        <div class="predefined-logo-name">${logo.name}</div>
                    `;
                };
                img.onerror = function() {
                    logoItem.innerHTML = `
                        <div style="width: 60px; height: 60px; background: #f0f0f0; border-radius: 5px; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center;">
                            <span style="font-size: 0.8rem; color: #666;">${logo.name}</span>
                        </div>
                        <div class="predefined-logo-name">${logo.name}</div>
                    `;
                };
                img.src = logo.url;
                
                logoItem.addEventListener('click', () => {
                    document.querySelectorAll('#predefinedLogos .predefined-logo-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    logoItem.classList.add('selected');
                    selectedPredefinedLogo = logo.url;
                });
                
                predefinedLogos.appendChild(logoItem);
                
                // Clone for both section
                const bothLogoItem = logoItem.cloneNode(true);
                bothLogoItem.addEventListener('click', () => {
                    document.querySelectorAll('#bothPredefinedLogos .predefined-logo-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    bothLogoItem.classList.add('selected');
                    selectedBothPredefinedLogo = logo.url;
                });
                
                bothPredefinedLogos.appendChild(bothLogoItem);
            });

            // Select first logo by default
            if (predefinedLogos.children.length > 0) {
                setTimeout(() => {
                    predefinedLogos.children[0].click();
                    bothPredefinedLogos.children[0].click();
                }, 100);
            }
        }

        // Initialize color options
        function initializeColorOptions() {
            textColorOptions.innerHTML = '';
            colorOptions.forEach(color => {
                const colorOption = document.createElement('div');
                colorOption.className = 'color-option';
                colorOption.style.backgroundColor = color;
                colorOption.dataset.color = color;
                
                colorOption.addEventListener('click', () => {
                    textColor.value = color;
                    updateColorPreview(color, textColorBackground, textColorOptions);
                });
                
                textColorOptions.appendChild(colorOption);
            });

            bothTextColorOptions.innerHTML = '';
            colorOptions.forEach(color => {
                const colorOption = document.createElement('div');
                colorOption.className = 'color-option';
                colorOption.style.backgroundColor = color;
                colorOption.dataset.color = color;
                
                colorOption.addEventListener('click', () => {
                    bothTextColor.value = color;
                    updateColorPreview(color, bothTextColorBackground, bothTextColorOptions);
                });
                
                bothTextColorOptions.appendChild(colorOption);
            });

            updateColorPreview(textColor.value, textColorBackground, textColorOptions);
            updateColorPreview(bothTextColor.value, bothTextColorBackground, bothTextColorOptions);
        }

        // Update color preview
        function updateColorPreview(color, backgroundElement, optionsContainer) {
            backgroundElement.style.backgroundColor = color;
            
            const colorOptions = optionsContainer.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                if (option.dataset.color === color) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        function updateOpacityValue() {
            opacityValue.textContent = Math.round(opacity.value * 100) + '%';
        }

        function updateImageSizeValue() {
            imageSizeValue.textContent = imageSize.value + '%';
        }

        function updateBothImageSizeValue() {
            bothImageSizeValue.textContent = bothImageSize.value + '%';
        }

        function updateFontPreview() {
            fontPreview.style.fontFamily = fontFamily.value;
            fontPreview.textContent = `${fontFamily.value} - Font Preview`;
        }

        function updateBothFontPreview() {
            bothFontPreview.style.fontFamily = bothFontFamily.value;
            bothFontPreview.textContent = `${bothFontFamily.value} - Font Preview`;
        }

        function toggleTextWatermark() {
            textCheckbox.classList.toggle('checked');
            bothTextControls.classList.toggle('hidden', !textCheckbox.classList.contains('checked'));
        }

        function toggleImageWatermark() {
            imageCheckbox.classList.toggle('checked');
            bothImageControls.classList.toggle('hidden', !imageCheckbox.classList.contains('checked'));
        }

        function handleWatermarkImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                watermarkImageData = e.target.result;
                watermarkPreview.src = watermarkImageData;
                watermarkPreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function handleBothWatermarkImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                bothWatermarkImageData = e.target.result;
                bothWatermarkPreview.src = bothWatermarkImageData;
                bothWatermarkPreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function handleImageUpload(event) {
            console.log("handleImageUpload called");
            
            const files = event.target.files;
            if (!files || files.length === 0) {
                console.log("No files selected");
                return;
            }

            console.log(`${files.length} files selected`);
            
            originalImages = [];
            watermarkedImages = [];
            previewSection.innerHTML = '';
            statsSection.classList.remove('hidden');
            selectedFiles.classList.remove('hidden');
            fileList.innerHTML = '';
            downloadButtons.classList.add('hidden');

            fileInfo.textContent = `${files.length} images selected`;
            fileInputButton.textContent = `üì∏ ${files.length} Images Selected`;

            const filesArray = Array.from(files);
            const imageFiles = filesArray.filter(file => {
                return file.type.startsWith('image/') || 
                       file.name.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg|tiff)$/i);
            });
            
            if (imageFiles.length === 0) {
                alert('Please select valid image files (JPEG, PNG, GIF, WebP, BMP, SVG, TIFF formats are supported)');
                return;
            }

            console.log(`${imageFiles.length} valid image files`);
            
            previewSection.innerHTML = '';

            // Clear and populate file list
            imageFiles.forEach((file, index) => {
                const fileItem = document.createElement('li');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <span class="file-remove" data-index="${index}">‚úï</span>
                `;
                fileList.appendChild(fileItem);
            });

            let loadedCount = 0;
            const totalImages = imageFiles.length;

            imageFiles.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const imgData = {
                        id: index,
                        name: file.name,
                        originalUrl: e.target.result,
                        file: file,
                        uploadOrder: index
                    };
                    
                    originalImages.push(imgData);
                    originalImages.sort((a, b) => a.uploadOrder - b.uploadOrder);
                    
                    createPreview(imgData, 'original');
                    
                    loadedCount++;
                    updateStats();
                    
                    if (loadedCount === totalImages) {
                        processBtn.disabled = false;
                        console.log(`All ${totalImages} images loaded successfully`);
                        
                        // Add event listeners to remove buttons
                        document.querySelectorAll('.file-remove').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const index = parseInt(btn.dataset.index);
                                removeImage(index);
                            });
                        });
                    }
                };
                
                reader.onerror = function() {
                    console.error('Error loading image:', file.name);
                    loadedCount++;
                    if (loadedCount === totalImages) {
                        processBtn.disabled = originalImages.length === 0;
                    }
                };
                
                reader.readAsDataURL(file);
            });
        }

        function removeImage(index) {
            originalImages = originalImages.filter(img => img.id !== index);
            watermarkedImages = watermarkedImages.filter(img => img.id !== index);
            
            originalImages.forEach((img, newIndex) => {
                img.id = newIndex;
            });
            
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach((item, itemIndex) => {
                if (parseInt(item.querySelector('.file-remove').dataset.index) === index) {
                    item.remove();
                }
            });
            
            document.querySelectorAll('.file-remove').forEach((btn, btnIndex) => {
                btn.dataset.index = btnIndex;
            });
            
            previewSection.innerHTML = '';
            originalImages.forEach(imgData => {
                createPreview(imgData, 'original');
            });
            watermarkedImages.forEach(imgData => {
                createPreview(imgData, 'watermarked');
            });
            
            updateStats();
            processBtn.disabled = originalImages.length === 0;
            
            if (originalImages.length === 0) {
                fileInfo.textContent = 'No files selected';
                fileInputButton.textContent = 'üì∏ Select Images';
                selectedFiles.classList.add('hidden');
                statsSection.classList.add('hidden');
                downloadButtons.classList.add('hidden');
                previewSection.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Uploaded images will appear here</div>';
            } else {
                fileInfo.textContent = `${originalImages.length} images selected`;
                fileInputButton.textContent = `üì∏ ${originalImages.length} Images Selected`;
            }
        }

        function updateStats() {
            totalCount.textContent = originalImages.length;
            processedCount.textContent = watermarkedImages.length;
            remainingCount.textContent = originalImages.length - watermarkedImages.length;
        }

        function createPreview(imgData, type) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.id = `preview-${type}-${imgData.id}`;
            previewItem.addEventListener('click', () => openModal(imgData.id, type));
            
            const img = document.createElement('img');
            img.className = 'preview-img';
            img.src = type === 'watermarked' ? imgData.watermarkedUrl : imgData.originalUrl;
            img.alt = imgData.name;
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'preview-name';
            
            const badge = type === 'watermarked' ? '‚úÖ ' : 'üì∑ ';
            nameDiv.textContent = badge + imgData.name.substring(0, 20) + (imgData.name.length > 20 ? '...' : '');
            
            const serialBadge = document.createElement('div');
            serialBadge.className = 'preview-badge';
            serialBadge.textContent = `#${imgData.id + 1}`;
            
            previewItem.appendChild(img);
            previewItem.appendChild(nameDiv);
            previewItem.appendChild(serialBadge);
            
            previewSection.appendChild(previewItem);
        }

        function openModal(index, type) {
            const images = type === 'watermarked' ? watermarkedImages : originalImages;
            if (images.length === 0) return;
            
            currentPreviewType = type;
            
            const imgData = images.find(img => img.id === index);
            if (!imgData) {
                currentPreviewIndex = 0;
                const firstImgData = images[0];
                modalImg.src = type === 'watermarked' ? firstImgData.watermarkedUrl : firstImgData.originalUrl;
                modalInfo.textContent = `${firstImgData.name} (1/${images.length})`;
            } else {
                currentPreviewIndex = images.findIndex(img => img.id === index);
                modalImg.src = type === 'watermarked' ? imgData.watermarkedUrl : imgData.originalUrl;
                modalInfo.textContent = `${imgData.name} (${currentPreviewIndex + 1}/${images.length})`;
            }
            
            previewModal.style.display = 'flex';
            
            modalPrev.style.display = images.length > 1 ? 'flex' : 'none';
            modalNext.style.display = images.length > 1 ? 'flex' : 'none';
        }

        function closeModal() {
            previewModal.style.display = 'none';
        }

        function showPrevImage() {
            const images = currentPreviewType === 'watermarked' ? watermarkedImages : originalImages;
            if (images.length === 0) return;
            
            currentPreviewIndex = (currentPreviewIndex - 1 + images.length) % images.length;
            const imgData = images[currentPreviewIndex];
            modalImg.src = currentPreviewType === 'watermarked' ? imgData.watermarkedUrl : imgData.originalUrl;
            modalInfo.textContent = `${imgData.name} (${currentPreviewIndex + 1}/${images.length})`;
        }

        function showNextImage() {
            const images = currentPreviewType === 'watermarked' ? watermarkedImages : originalImages;
            if (images.length === 0) return;
            
            currentPreviewIndex = (currentPreviewIndex + 1) % images.length;
            const imgData = images[currentPreviewIndex];
            modalImg.src = currentPreviewType === 'watermarked' ? imgData.watermarkedUrl : imgData.originalUrl;
            modalInfo.textContent = `${imgData.name} (${currentPreviewIndex + 1}/${images.length})`;
        }

        function processAllImages() {
            if (originalImages.length === 0) return;

            if (currentWatermarkType === 'image') {
                if (currentLogoSource === 'upload' && !watermarkImageData) {
                    alert('Please select a watermark image');
                    return;
                }
                if (currentLogoSource === 'predefined' && !selectedPredefinedLogo) {
                    alert('Please select a predefined logo');
                    return;
                }
            }

            if (currentWatermarkType === 'both') {
                if (!textCheckbox.classList.contains('checked') && !imageCheckbox.classList.contains('checked')) {
                    alert('Please select text or image watermark');
                    return;
                }
                if (textCheckbox.classList.contains('checked') && !bothWatermarkText.value.trim()) {
                    alert('Please enter watermark text');
                    return;
                }
                if (imageCheckbox.classList.contains('checked')) {
                    if (currentBothLogoSource === 'upload' && !bothWatermarkImageData) {
                        alert('Please select a watermark image');
                        return;
                    }
                    if (currentBothLogoSource === 'predefined' && !selectedBothPredefinedLogo) {
                        alert('Please select a predefined logo');
                        return;
                    }
                }
            }

            watermarkedImages = [];
            processBtn.disabled = true;
            downloadButtons.classList.add('hidden');
            loadingSpinner.style.display = 'block';
            progress.style.width = '0%';
            progressText.textContent = '0% Complete';

            let processed = 0;
            const total = originalImages.length;

            function processNextImage(index) {
                if (index >= originalImages.length) {
                    loadingSpinner.style.display = 'none';
                    processBtn.disabled = false;
                    downloadButtons.classList.remove('hidden');
                    
                    watermarkedImages.sort((a, b) => a.id - b.id);
                    return;
                }

                const imgData = originalImages[index];
                
                processSingleImage(imgData).then(() => {
                    processed++;
                    
                    const progressPercent = (processed / total) * 100;
                    progress.style.width = progressPercent + '%';
                    progressText.textContent = `${Math.round(progressPercent)}% Complete`;
                    updateStats();
                    
                    setTimeout(() => processNextImage(index + 1), 100);
                }).catch(error => {
                    console.error('Error processing image:', error);
                    processed++;
                    updateStats();
                    setTimeout(() => processNextImage(index + 1), 100);
                });
            }

            processNextImage(0);
        }

        function processSingleImage(imgData) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    try {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        ctx.drawImage(img, 0, 0);
                        
                        if (currentWatermarkType === 'text') {
                            applyTextWatermark(ctx, canvas.width, canvas.height);
                            finishProcessing();
                        } else if (currentWatermarkType === 'image') {
                            applyImageWatermark(ctx, canvas.width, canvas.height).then(() => {
                                finishProcessing();
                            }).catch(reject);
                        } else if (currentWatermarkType === 'both') {
                            applyBothWatermark(ctx, canvas.width, canvas.height).then(() => {
                                finishProcessing();
                            }).catch(reject);
                        } else {
                            finishProcessing();
                        }
                        
                        function finishProcessing() {
                            const watermarkedUrl = canvas.toDataURL('image/jpeg', 0.9);
                            
                            const watermarkedData = {
                                ...imgData,
                                watermarkedUrl: watermarkedUrl
                            };
                            
                            watermarkedImages.push(watermarkedData);
                            
                            createPreview(watermarkedData, 'watermarked');
                            resolve();
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = reject;
                img.src = imgData.originalUrl;
            });
        }

        function applyTextWatermark(ctx, width, height) {
            const text = watermarkText.value;
            const fontSize = parseInt(textSize.value);
            const color = textColor.value;
            const alpha = parseFloat(opacity.value);
            const pos = position.value;
            const font = fontFamily.value;
            
            ctx.font = `bold ${fontSize}px ${font}`;
            ctx.fillStyle = color;
            ctx.globalAlpha = alpha;
            ctx.textAlign = 'right';
            ctx.textBaseline = 'bottom';
            
            let x, y;
            const padding = 20;
            
            switch(pos) {
                case 'bottom-right':
                    x = width - padding;
                    y = height - padding;
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'bottom';
                    break;
                case 'bottom-left':
                    x = padding;
                    y = height - padding;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'bottom';
                    break;
                case 'top-right':
                    x = width - padding;
                    y = padding;
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'top';
                    break;
                case 'top-left':
                    x = padding;
                    y = padding;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'top';
                    break;
                case 'center':
                    x = width / 2;
                    y = height / 2;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    break;
                case 'tile':
                    applyTiledWatermark(ctx, width, height, () => {
                        ctx.fillText(text, 0, 0);
                    }, fontSize * 2);
                    return;
            }
            
            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
            ctx.shadowBlur = 3;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            ctx.fillText(text, x, y);
        }

        function applyImageWatermark(ctx, width, height) {
            return new Promise((resolve, reject) => {
                let watermarkSrc;
                
                if (currentLogoSource === 'upload') {
                    if (!watermarkImageData) {
                        reject('No watermark image');
                        return;
                    }
                    watermarkSrc = watermarkImageData;
                } else {
                    if (!selectedPredefinedLogo) {
                        reject('No predefined logo selected');
                        return;
                    }
                    watermarkSrc = selectedPredefinedLogo;
                }

                const watermarkImg = new Image();
                watermarkImg.onload = function() {
                    const alpha = parseFloat(opacity.value);
                    const pos = position.value;
                    const sizePercent = parseInt(imageSize.value) / 100;
                    
                    const watermarkWidth = watermarkImg.width * sizePercent;
                    const watermarkHeight = watermarkImg.height * sizePercent;
                    
                    ctx.globalAlpha = alpha;
                    
                    if (pos === 'tile') {
                        applyTiledWatermark(ctx, width, height, () => {
                            ctx.drawImage(watermarkImg, 0, 0, watermarkWidth, watermarkHeight);
                        }, watermarkWidth * 2);
                    } else {
                        let x, y;
                        const padding = 20;
                        
                        switch(pos) {
                            case 'bottom-right':
                                x = width - watermarkWidth - padding;
                                y = height - watermarkHeight - padding;
                                break;
                            case 'bottom-left':
                                x = padding;
                                y = height - watermarkHeight - padding;
                                break;
                            case 'top-right':
                                x = width - watermarkWidth - padding;
                                y = padding;
                                break;
                            case 'top-left':
                                x = padding;
                                y = padding;
                                break;
                            case 'center':
                                x = (width - watermarkWidth) / 2;
                                y = (height - watermarkHeight) / 2;
                                break;
                        }
                        
                        ctx.drawImage(watermarkImg, x, y, watermarkWidth, watermarkHeight);
                    }
                    resolve();
                };
                watermarkImg.onerror = reject;
                watermarkImg.src = watermarkSrc;
            });
        }

        function applyBothWatermark(ctx, width, height) {
            return new Promise((resolve, reject) => {
                const alpha = parseFloat(opacity.value);
                const pos = position.value;
                
                if (imageCheckbox.classList.contains('checked')) {
                    let watermarkSrc;
                    
                    if (currentBothLogoSource === 'upload') {
                        if (!bothWatermarkImageData) {
                            reject('No watermark image');
                            return;
                        }
                        watermarkSrc = bothWatermarkImageData;
                    } else {
                        if (!selectedBothPredefinedLogo) {
                            reject('No predefined logo selected');
                            return;
                        }
                        watermarkSrc = selectedBothPredefinedLogo;
                    }

                    const watermarkImg = new Image();
                    watermarkImg.onload = function() {
                        const sizePercent = parseInt(bothImageSize.value) / 100;
                        const watermarkWidth = watermarkImg.width * sizePercent;
                        const watermarkHeight = watermarkImg.height * sizePercent;
                        
                        ctx.globalAlpha = alpha;
                        
                        if (pos === 'tile') {
                            applyTiledWatermark(ctx, width, height, () => {
                                ctx.drawImage(watermarkImg, 0, 0, watermarkWidth, watermarkHeight);
                            }, watermarkWidth * 2);
                        } else {
                            let x, y;
                            const padding = 20;
                            
                            switch(pos) {
                                case 'bottom-right':
                                    x = width - watermarkWidth - padding;
                                    y = height - watermarkHeight - padding;
                                    break;
                                case 'bottom-left':
                                    x = padding;
                                    y = height - watermarkHeight - padding;
                                    break;
                                case 'top-right':
                                    x = width - watermarkWidth - padding;
                                    y = padding;
                                    break;
                                case 'top-left':
                                    x = padding;
                                    y = padding;
                                    break;
                                case 'center':
                                    x = (width - watermarkWidth) / 2;
                                    y = (height - watermarkHeight) / 2;
                                    break;
                            }
                            
                            ctx.drawImage(watermarkImg, x, y, watermarkWidth, watermarkHeight);
                            
                            // Apply text watermark below the image
                            if (textCheckbox.classList.contains('checked')) {
                                applyBothTextWatermark(ctx, width, height, watermarkWidth, watermarkHeight, pos, x, y);
                            }
                        }
                        resolve();
                    };
                    watermarkImg.onerror = reject;
                    watermarkImg.src = watermarkSrc;
                } else {
                    if (textCheckbox.classList.contains('checked')) {
                        applyBothTextWatermark(ctx, width, height, 0, 0, pos, 0, 0);
                    }
                    resolve();
                }
            });
        }

        function applyBothTextWatermark(ctx, width, height, imageWidth, imageHeight, pos, imageX, imageY) {
            const text = bothWatermarkText.value;
            const fontSize = parseInt(bothTextSize.value);
            const color = bothTextColor.value;
            const alpha = parseFloat(opacity.value);
            const font = bothFontFamily.value;
            
            ctx.font = `bold ${fontSize}px ${font}`;
            ctx.fillStyle = color;
            ctx.globalAlpha = alpha;
            
            let x, y;
            const padding = 20;
            
            // For all positions, place text below the image
            switch(pos) {
                case 'bottom-right':
                case 'bottom-left':
                case 'top-right':
                case 'top-left':
                case 'center':
                    x = imageX + imageWidth / 2;
                    y = imageY + imageHeight + padding;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    break;
                case 'tile':
                    applyTiledWatermark(ctx, width, height, () => {
                        ctx.fillText(text, 0, 0);
                    }, fontSize * 2);
                    return;
            }
            
            // If text would be drawn outside the canvas, adjust position
            if (y + fontSize > height) {
                y = imageY - padding;
                ctx.textBaseline = 'bottom';
            }
            
            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
            ctx.shadowBlur = 3;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            ctx.fillText(text, x, y);
        }

        function applyTiledWatermark(ctx, width, height, drawFunction, spacing) {
            for (let x = 0; x < width; x += spacing) {
                for (let y = 0; y < height; y += spacing) {
                    ctx.save();
                    ctx.translate(x, y);
                    drawFunction();
                    ctx.restore();
                }
            }
        }

        function downloadAllImages() {
            if (watermarkedImages.length === 0) return;
            
            if (confirm(`You are about to download ${watermarkedImages.length} images. Continue?`)) {
                const sortedImages = [...watermarkedImages].sort((a, b) => a.id - b.id);
                
                function downloadNextImage(index) {
                    if (index >= sortedImages.length) {
                        alert('All images downloaded successfully!');
                        return;
                    }
                    
                    const imgData = sortedImages[index];
                    downloadSingleImage(imgData, index);
                    
                    setTimeout(() => {
                        downloadNextImage(index + 1);
                    }, 1000);
                }
                
                downloadNextImage(0);
            }
        }

        function downloadSingleImage(imgData, sequenceNumber) {
            const link = document.createElement('a');
            const sequence = (sequenceNumber + 1).toString().padStart(3, '0');
            const originalName = imgData.name.replace(/\.[^/.]+$/, "");
            const extension = imgData.name.split('.').pop();
            const fileName = `${sequence}_${originalName}_watermarked.${extension}`;
            
            link.download = fileName;
            link.href = imgData.watermarkedUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadAsZip() {
            if (watermarkedImages.length === 0) return;
            
            if (confirm(`You are about to download ${watermarkedImages.length} images as a ZIP file. Continue?`)) {
                loadingSpinner.style.display = 'block';
                
                const zip = new JSZip();
                let processed = 0;
                
                const sortedImages = [...watermarkedImages].sort((a, b) => a.id - b.id);
                
                sortedImages.forEach((imgData, index) => {
                    fetch(imgData.watermarkedUrl)
                        .then(res => res.blob())
                        .then(blob => {
                            const sequence = (index + 1).toString().padStart(3, '0');
                            const originalName = imgData.name.replace(/\.[^/.]+$/, "");
                            const extension = imgData.name.split('.').pop();
                            const fileName = `${sequence}_${originalName}_watermarked.${extension}`;
                            
                            zip.file(fileName, blob);
                            processed++;
                            
                            if (processed === sortedImages.length) {
                                zip.generateAsync({type: "blob"})
                                    .then(function(content) {
                                        saveAs(content, "watermarked_images.zip");
                                        loadingSpinner.style.display = 'none';
                                        alert('ZIP file downloaded successfully!');
                                    })
                                    .catch(error => {
                                        console.error('Error generating ZIP:', error);
                                        loadingSpinner.style.display = 'none';
                                        alert('Error generating ZIP file');
                                    });
                            }
                        })
                        .catch(error => {
                            console.error('Error processing image for ZIP:', error);
                            processed++;
                            if (processed === sortedImages.length) {
                                zip.generateAsync({type: "blob"})
                                    .then(function(content) {
                                        saveAs(content, "watermarked_images.zip");
                                        loadingSpinner.style.display = 'none';
                                        alert('ZIP file downloaded with some errors');
                                    });
                            }
                        });
                });
            }
        }

        // Initialize
        updateOpacityValue();
        updateImageSizeValue();
        updateBothImageSizeValue();
        updateFontPreview();
        updateBothFontPreview();
        initializePredefinedLogos();
        initializeColorOptions();
        
        // Test if everything is working
        console.log("Batch Image Watermark Tool initialized successfully");
    </script>
</body>
    </html>
